<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/app.css" />
  <title>Cloud Notes</title>
</head>
<body>
  <div class="layout">
    <div class="ribbon">
      <button title="Explorer">üìÅ</button>
      <button title="Search">üîç</button>
      <button title="Links">üîó</button>
      <button title="Settings">‚öôÔ∏è</button>
    </div>

    <aside class="sidebar">
      <div class="vault-selector">
        <select id="vaultSelect" class="vault-select"></select>
        <a class="manage-link" href="/vaults.html">Manage</a>
      </div>

      <div class="section-title">Notebook</div>
      <div class="actions">
        <button id="newNoteBtn" class="primary">+ New</button>
        <button id="refreshBtn">‚ü≥</button>
      </div>

      <input id="searchInput" placeholder="Search notes..." />

      <div class="section-title">Folders</div>
      <div class="folder-new">
        <input id="folderNameInput" placeholder="New folder name" />
        <button id="addFolderBtn">+ Folder</button>
      </div>
      <div id="folderList" class="folder-list"></div>

      <div class="section-title">Notes</div>
      <div id="fileList" class="file-list"></div>
    </aside>

    <main class="main">
      <div class="topbar">
        <button class="nav-btn" title="Back">‚Üê</button>
        <button class="nav-btn" title="Forward">‚Üí</button>
        <div class="tabstrip" id="tabStrip"></div>
        <button id="logoutBtn" class="nav-btn" title="Logout">‚éã</button>
      </div>

      <div class="note-pane">
        <div class="note-editor">
          <input id="noteTitleInput" class="note-title-input" placeholder="Note title" />
          <textarea id="noteContentInput" class="note-content-input" placeholder="Write your note..."></textarea>
          <div class="save-row">
            <button id="saveNoteBtn">Save</button>
            <span id="noteStatus" class="small"></span>
          </div>
        </div>
      </div>

      <div class="statusbar">
        <span id="wordCount">0 words</span>
        <span id="charCount">0 chars</span>
        <span id="backlinks">0 backlinks</span>
      </div>
    </main>

    <aside class="outline">
      <h3>Outline</h3>
      <div id="outlineList"></div>
    </aside>
  </div>

  <script>
    const token = localStorage.getItem("token");
    if (!token) window.location.href = "/login.html";

    const vaultSelect = document.getElementById("vaultSelect");
    const folderListEl = document.getElementById("folderList");
    const fileList = document.getElementById("fileList");
    const tabStrip = document.getElementById("tabStrip");
    const wordCount = document.getElementById("wordCount");
    const charCount = document.getElementById("charCount");
    const outlineList = document.getElementById("outlineList");
    const searchInput = document.getElementById("searchInput");
    const folderNameInput = document.getElementById("folderNameInput");
    const addFolderBtn = document.getElementById("addFolderBtn");
    const noteTitleInput = document.getElementById("noteTitleInput");
    const noteContentInput = document.getElementById("noteContentInput");
    const saveNoteBtn = document.getElementById("saveNoteBtn");
    const noteStatus = document.getElementById("noteStatus");

    let vaults = [];
    let currentVaultId = localStorage.getItem("currentVaultId") || null;
    let folders = [];
    let currentFolderId = null;
    let notesCache = [];
    let activeNoteId = null;
    const noteDetails = new Map(); // noteId -> detail

    document.getElementById("logoutBtn").onclick = () => {
      localStorage.removeItem("token");
      window.location.href = "/login.html";
    };

    document.getElementById("newNoteBtn").onclick = async () => {
      if (!currentVaultId) return;
      const r = await fetch(`/vaults/${currentVaultId}/notes`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token
        },
        body: JSON.stringify({ title: "Untitled", content: "", folder_id: currentFolderId })
      });
      if (r.ok) {
        const data = await r.json().catch(() => ({}));
        await loadNotes();
        if (data.note) setActiveNote(data.note.id, true);
      }
    };

    document.getElementById("refreshBtn").onclick = () => loadVaults();
    searchInput.oninput = () => renderFileList();

    vaultSelect.onchange = () => {
      currentVaultId = vaultSelect.value || null;
      if (currentVaultId) localStorage.setItem("currentVaultId", currentVaultId);
      currentFolderId = null;
      activeNoteId = null;
      noteDetails.clear();
      loadFolders();
      loadNotes();
    };

    function deriveTitle(note) {
      const t = (note.title || "").trim();
      if (t) return t.length > 60 ? t.slice(0, 60) + "‚Ä¶" : t;
      return "Untitled";
    }

    function renderNote(detail) {
      if (!detail) return;
      activeNoteId = detail.id;
      noteDetails.set(detail.id, detail);
      noteTitleInput.value = detail.title || "";
      noteContentInput.value = detail.content || "";
      updateCounts(detail.content || "");
      renderTabs();
      renderOutline(detail.content || "");
      highlightActive();
    }

    function renderOutline(content) {
      outlineList.innerHTML = "";
      const lines = content.split(/\\r?\\n/);
      lines.forEach((line) => {
        const match = line.match(/^(#{1,3})\\s+(.*)/);
        if (match) {
          const level = match[1].length;
          const text = match[2];
          const item = document.createElement("div");
          item.className = "outline-item";
          item.style.paddingLeft = `${(level - 1) * 12}px`;
          item.textContent = text;
          item.onclick = () => scrollToHeading(text);
          outlineList.appendChild(item);
        }
      });
    }

    function scrollToHeading(text) {
      const headings = document.querySelectorAll(".note-pane h1, .note-pane h2, .note-pane h3");
      for (const h of headings) {
        if (h.textContent.trim() === text.trim()) {
          h.scrollIntoView({ behavior: "smooth", block: "start" });
          break;
        }
      }
    }

    function renderTabs() {
      tabStrip.innerHTML = "";
      notesCache.slice(0, 5).forEach(n => {
        const t = document.createElement("div");
        t.className = "tab" + (n.id === activeNoteId ? " active" : "");
        t.textContent = deriveTitle(n);
        t.onclick = () => setActiveNote(n.id, true);
        tabStrip.appendChild(t);
      });
    }

    function highlightActive() {
      Array.from(fileList.children).forEach(el => {
        const id = el.dataset.id;
        el.classList.toggle("active", id === activeNoteId);
      });
    }

    function updateCounts(text) {
      const words = text.trim() ? text.trim().split(/\\s+/).length : 0;
      wordCount.textContent = `${words} word${words === 1 ? "" : "s"}`;
      charCount.textContent = `${text.length} chars`;
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    async function loadVaults() {
      const r = await fetch("/vaults", {
        headers: { Authorization: "Bearer " + token }
      });
      const data = await r.json().catch(() => ({}));
      vaults = data.vaults || [];
      vaultSelect.innerHTML = "";
      vaults.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v.id;
        opt.textContent = v.title || v.name;
        vaultSelect.appendChild(opt);
      });
      if (!currentVaultId && vaults.length) {
        currentVaultId = vaults[0].id;
      } else if (currentVaultId && !vaults.find(v => v.id === currentVaultId) && vaults.length) {
        currentVaultId = vaults[0].id;
      }
      if (currentVaultId) {
        vaultSelect.value = currentVaultId;
        localStorage.setItem("currentVaultId", currentVaultId);
        await loadFolders();
        await loadNotes();
      } else {
        fileList.innerHTML = "<div class='file'>No vaults. Create one in Manage.</div>";
      }
    }

    async function loadFolders() {
      if (!currentVaultId) return;
      const r = await fetch(`/vaults/${currentVaultId}/folders`, {
        headers: { Authorization: "Bearer " + token }
      });
      const data = await r.json().catch(() => ({}));
      folders = data.folders || [];
      renderFolderList();
    }

    function renderFolderList() {
      folderListEl.innerHTML = "";
      const inbox = document.createElement("div");
      inbox.className = "folder-item" + (currentFolderId ? "" : " active");
      inbox.textContent = "Inbox";
      inbox.onclick = () => {
        currentFolderId = null;
        loadNotes();
      };
      folderListEl.appendChild(inbox);

      folders.forEach(f => {
        const el = document.createElement("div");
        el.className = "folder-item" + (currentFolderId === f.id ? " active" : "");
        el.textContent = f.title || f.name;
        el.onclick = () => {
          currentFolderId = f.id;
          loadNotes();
        };
        folderListEl.appendChild(el);
      });
    }

    async function loadNotes() {
      if (!currentVaultId) return;
      const params = new URLSearchParams();
      if (currentFolderId) params.set("folder_id", currentFolderId);
      params.set("archived", "false");
      const r = await fetch(`/vaults/${currentVaultId}/notes?${params.toString()}`, {
        headers: { Authorization: "Bearer " + token }
      });
      const data = await r.json().catch(() => ({}));
      if (!r.ok) {
        fileList.innerHTML = `<div class="file">Error loading notes</div>`;
        return;
      }
      const query = searchInput.value.trim().toLowerCase();
      notesCache = (data.notes || []).filter(n => {
        if (!query) return true;
        const blob = `${deriveTitle(n)}`.toLowerCase();
        return blob.includes(query);
      });
      renderFileList();
      renderTabs();
      if (activeNoteId == null && notesCache.length) {
        setActiveNote(notesCache[0].id, true);
      } else if (activeNoteId != null) {
        const detail = noteDetails.get(activeNoteId);
        if (detail) renderNote(detail);
      }
    }

    function renderFileList() {
      fileList.innerHTML = "";
      notesCache.forEach(n => {
        const el = document.createElement("div");
        el.className = "file";
        el.dataset.id = n.id;
        el.innerHTML = `
          <div>${escapeHtml(deriveTitle(n))}</div>
          <div class="small" style="color: var(--muted);">${new Date(n.updated_at || n.created_at).toLocaleString()}</div>
        `;
        el.onclick = () => setActiveNote(n.id, true);
        fileList.appendChild(el);
      });
      highlightActive();
    }

    async function setActiveNote(id, fetchDetail = false) {
      activeNoteId = id;
      highlightActive();
      if (!fetchDetail) {
        const cached = noteDetails.get(id);
        if (cached) {
          renderNote(cached);
          return;
        }
      }
      if (!currentVaultId) return;
      const r = await fetch(`/vaults/${currentVaultId}/notes/${id}`, {
        headers: { Authorization: "Bearer " + token }
      });
      const data = await r.json().catch(() => ({}));
      if (!r.ok) {
        return;
      }
      if (data.note) {
        noteDetails.set(id, data.note);
        renderNote(data.note);
      }
    }

    addFolderBtn.onclick = async () => {
      const name = folderNameInput.value.trim();
      if (!name || !currentVaultId) return;
      const r = await fetch(`/vaults/${currentVaultId}/folders`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token
        },
        body: JSON.stringify({ name, title: name })
      });
      if (r.ok) {
        folderNameInput.value = "";
        await loadFolders();
      }
    };

    saveNoteBtn.onclick = async () => {
      if (!currentVaultId || !activeNoteId) return;
      noteStatus.textContent = "Saving...";
      const body = {
        title: noteTitleInput.value.trim() || "Untitled",
        content: noteContentInput.value,
        folder_id: currentFolderId
      };
      const r = await fetch(`/vaults/${currentVaultId}/notes/${activeNoteId}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token
        },
        body: JSON.stringify(body)
      });
      const data = await r.json().catch(() => ({}));
      if (!r.ok) {
        noteStatus.textContent = data.error || "Save failed";
        return;
      }
      noteStatus.textContent = "Saved";
      noteDetails.set(activeNoteId, data.note);
      await loadNotes();
    };

    noteContentInput.addEventListener("input", () => {
      updateCounts(noteContentInput.value);
    });

    loadVaults();
  </script>
</body>
</html>
