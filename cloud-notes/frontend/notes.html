<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/app.css" />
  <title>Cloud Notes</title>
</head>
<body>
  <div class="layout" id="layoutRoot">
    <div class="ribbon">
      <button id="btnExplorer" title="Explorer" class="active">üìÅ</button>
      <button id="btnSearch" title="Search">üîç</button>
      <button id="btnLinks" title="Links">üîó</button>
      <button id="btnSettings" title="Settings">‚öôÔ∏è</button>
    </div>

    <aside class="sidebar">
      <div id="paneExplorer" class="sidebar-pane active">
        <div class="vault-selector">
          <select id="vaultSelect" class="vault-select"></select>
          <a class="manage-link" href="/vaults.html">Manage</a>
        </div>

        <div class="section-title">Notebook</div>
        <div class="actions">
          <button id="newNoteBtn" class="primary">+ New</button>
          <button id="refreshBtn">‚ü≥</button>
        </div>

        <input id="searchInput" placeholder="Search notes..." />

        <div class="section-title">Folders</div>
        <div class="folder-new">
          <input id="folderNameInput" placeholder="New folder name" />
          <button id="addFolderBtn">+ Folder</button>
        </div>
        <div id="folderList" class="folder-list"></div>

        <div class="section-title">Notes</div>
        <div id="fileList" class="file-list"></div>
      </div>

      <div id="paneSearch" class="sidebar-pane search-pane">
        <input id="globalSearchInput" placeholder="Search all notes..." />
        <div class="placeholder-card">Search across your vault (coming soon).</div>
      </div>

      <div id="paneLinks" class="sidebar-pane links-pane">
        <div class="placeholder-card">Backlinks & mentions (coming soon).</div>
      </div>

      <div id="paneSettings" class="sidebar-pane settings-pane">
        <div class="placeholder-card">Settings panel (coming soon).</div>
        <button id="logoutBtn" class="primary">Logout</button>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <button class="nav-btn" title="Back">‚Üê</button>
        <button class="nav-btn" title="Forward">‚Üí</button>
        <div class="tabstrip" id="tabStrip"></div>
        <button id="outlineToggleBtn" class="nav-btn" title="Toggle outline">‚áÜ</button>
      </div>

      <div class="note-pane">
        <div class="note-editor">
          <input id="noteTitleInput" class="note-title-input" placeholder="Note title" />
          <textarea id="noteContentInput" class="note-content-input" placeholder="Write your note..."></textarea>
          <div class="save-row">
            <span id="noteStatus" class="small"></span>
          </div>
        </div>
      </div>

      <div class="statusbar">
        <span id="wordCount">0 words</span>
        <span id="charCount">0 chars</span>
        <span id="backlinks">0 backlinks</span>
      </div>
    </main>

    <aside class="outline" id="outlinePanel">
      <h3>Outline</h3>
      <div id="outlineList"></div>
    </aside>
  </div>

  <script>
    const token = localStorage.getItem("token");
    if (!token) window.location.href = "/login.html";

    const layoutRoot = document.getElementById("layoutRoot");
    const vaultSelect = document.getElementById("vaultSelect");
    const folderListEl = document.getElementById("folderList");
    const fileList = document.getElementById("fileList");
    const tabStrip = document.getElementById("tabStrip");
    const wordCount = document.getElementById("wordCount");
    const charCount = document.getElementById("charCount");
    const outlineList = document.getElementById("outlineList");
    const searchInput = document.getElementById("searchInput");
    const folderNameInput = document.getElementById("folderNameInput");
    const addFolderBtn = document.getElementById("addFolderBtn");
    const noteTitleInput = document.getElementById("noteTitleInput");
    const noteContentInput = document.getElementById("noteContentInput");
    const noteStatus = document.getElementById("noteStatus");
    const outlineToggleBtn = document.getElementById("outlineToggleBtn");

    const btnExplorer = document.getElementById("btnExplorer");
    const btnSearch = document.getElementById("btnSearch");
    const btnLinks = document.getElementById("btnLinks");
    const btnSettings = document.getElementById("btnSettings");
    const paneExplorer = document.getElementById("paneExplorer");
    const paneSearch = document.getElementById("paneSearch");
    const paneLinks = document.getElementById("paneLinks");
    const paneSettings = document.getElementById("paneSettings");

    let vaults = [];
    let currentVaultId = localStorage.getItem("currentVaultId") || null;
    let folders = [];
    let currentFolderId = null;
    let notesCache = [];
    let activeNoteId = null;
    const noteDetails = new Map();
    let saveTimer = null;
    let outlineCollapsed = false;

    function setSidebarMode(mode) {
      [paneExplorer, paneSearch, paneLinks, paneSettings].forEach(p => p.classList.remove("active"));
      [btnExplorer, btnSearch, btnLinks, btnSettings].forEach(b => b.classList.remove("active"));
      if (mode === "explorer") { paneExplorer.classList.add("active"); btnExplorer.classList.add("active"); }
      if (mode === "search")   { paneSearch.classList.add("active"); btnSearch.classList.add("active"); }
      if (mode === "links")    { paneLinks.classList.add("active"); btnLinks.classList.add("active"); }
      if (mode === "settings") { paneSettings.classList.add("active"); btnSettings.classList.add("active"); }
    }

    btnExplorer.onclick = () => setSidebarMode("explorer");
    btnSearch.onclick = () => setSidebarMode("search");
    btnLinks.onclick = () => setSidebarMode("links");
    btnSettings.onclick = () => setSidebarMode("settings");

    outlineToggleBtn.onclick = () => {
      outlineCollapsed = !outlineCollapsed;
      layoutRoot.classList.toggle("outline-collapsed", outlineCollapsed);
      outlineToggleBtn.textContent = outlineCollapsed ? "‚áá" : "‚áÜ";
    };

    document.getElementById("logoutBtn")?.addEventListener("click", () => {
      localStorage.removeItem("token");
      window.location.href = "/login.html";
    });

    document.getElementById("newNoteBtn").onclick = async () => {
      if (!currentVaultId) return;
      if (!currentFolderId) {
        noteStatus.textContent = "Select a folder first.";
        return;
      }
      const r = await fetch(`/vaults/${currentVaultId}/notes`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token
        },
        body: JSON.stringify({ title: "", content: "", folder_id: currentFolderId })
      });
      if (r.ok) {
        const data = await r.json().catch(() => ({}));
        await loadNotes();
        if (data.note) setActiveNote(data.note.id, true);
      }
    };

    document.getElementById("refreshBtn").onclick = () => loadVaults();
    searchInput.oninput = () => renderFileList();

    vaultSelect.onchange = () => {
      currentVaultId = vaultSelect.value || null;
      if (currentVaultId) localStorage.setItem("currentVaultId", currentVaultId);
      currentFolderId = null;
      activeNoteId = null;
      noteDetails.clear();
      loadFolders();
      loadNotes();
    };

    function deriveTitle(note) {
      const t = (note.title || "").trim();
      if (t) return t.length > 60 ? t.slice(0, 60) + "‚Ä¶" : t;
      return "";
    }

    function renderNote(detail) {
      if (!detail) return;
      activeNoteId = detail.id;
      noteDetails.set(detail.id, detail);
      noteTitleInput.value = detail.title || "";
      noteContentInput.value = detail.content || "";
      updateCounts(detail.content || "");
      renderTabs();
      renderOutline(detail.content || "");
      highlightActive();
    }

    function renderOutline(content) {
      outlineList.innerHTML = "";
      const lines = content.split(/\r?\n/);
      lines.forEach((line) => {
        const match = line.match(/^(#{1,3})\s+(.*)/);
        if (match) {
          const level = match[1].length;
          const text = match[2];
          const item = document.createElement("div");
          item.className = "outline-item";
          item.style.paddingLeft = `${(level - 1) * 12}px`;
          item.textContent = text;
          item.onclick = () => scrollToHeading(text);
          outlineList.appendChild(item);
        }
      });
    }

    function scrollToHeading(text) {
      const headings = document.querySelectorAll(".note-pane h1, .note-pane h2, .note-pane h3");
      for (const h of headings) {
        if (h.textContent.trim() === text.trim()) {
          h.scrollIntoView({ behavior: "smooth", block: "start" });
          break;
        }
      }
    }

    function renderTabs() {
      tabStrip.innerHTML = "";
      notesCache.slice(0, 5).forEach(n => {
        const t = document.createElement("div");
        t.className = "tab" + (n.id === activeNoteId ? " active" : "");
        t.textContent = deriveTitle(n);
        t.onclick = () => setActiveNote(n.id, true);
        tabStrip.appendChild(t);
      });
    }

    function highlightActive() {
      Array.from(fileList.children).forEach(el => {
        const id = el.dataset.id;
        el.classList.toggle("active", id === activeNoteId);
      });
    }

    function updateCounts(text) {
      const words = text.trim() ? text.trim().split(/\s+/).length : 0;
      wordCount.textContent = `${words} word${words === 1 ? "" : "s"}`;
      charCount.textContent = `${text.length} chars`;
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    async function loadVaults() {
      const r = await fetch("/vaults", {
        headers: { Authorization: "Bearer " + token }
      });
      const data = await r.json().catch(() => ({}));
      vaults = data.vaults || [];
      vaultSelect.innerHTML = "";
      vaults.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v.id;
        opt.textContent = v.title || v.name;
        vaultSelect.appendChild(opt);
      });
      if (!currentVaultId && vaults.length) {
        currentVaultId = vaults[0].id;
      } else if (currentVaultId && !vaults.find(v => v.id === currentVaultId) && vaults.length) {
        currentVaultId = vaults[0].id;
      }
      if (currentVaultId) {
        vaultSelect.value = currentVaultId;
        localStorage.setItem("currentVaultId", currentVaultId);
        await loadFolders();
        await loadNotes();
      } else {
        fileList.innerHTML = "<div class='file'>No vaults. Create one in Manage.</div>";
      }
    }

    async function loadFolders() {
      if (!currentVaultId) return;
      const r = await fetch(`/vaults/${currentVaultId}/folders`, {
        headers: { Authorization: "Bearer " + token }
      });
      const data = await r.json().catch(() => ({}));
      folders = data.folders || [];
      if ((!currentFolderId || !folders.find(f => f.id === currentFolderId)) && folders.length) {
        currentFolderId = folders[0].id;
      }
      renderFolderList();
    }

    function renderFolderList() {
      folderListEl.innerHTML = "";
      folders.forEach(f => {
        const el = document.createElement("div");
        el.className = "folder-item" + (currentFolderId === f.id ? " active" : "");
        el.textContent = f.title || f.name;
        el.onclick = () => {
          currentFolderId = f.id;
          activeNoteId = null;
          loadNotes();
        };
        folderListEl.appendChild(el);
      });
    }

    addFolderBtn.onclick = async () => {
      const name = folderNameInput.value.trim();
      if (!name || !currentVaultId) return;
      const r = await fetch(`/vaults/${currentVaultId}/folders`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token
        },
        body: JSON.stringify({ name, title: name })
      });
      const data = await r.json().catch(() => ({}));
      if (!r.ok) {
        noteStatus.textContent = data.error || "Folder create failed";
        return;
      }
      folderNameInput.value = "";
      if (data.folder?.id) currentFolderId = data.folder.id;
      await loadFolders();
      await loadNotes();
    };

    async function loadNotes() {
      if (!currentVaultId) return;
      if (!currentFolderId) {
        fileList.innerHTML = `<div class="file">Select a folder to view notes</div>`;
        return;
      }
      const params = new URLSearchParams();
      if (currentFolderId) params.set("folder_id", currentFolderId);
      params.set("archived", "false");
      const r = await fetch(`/vaults/${currentVaultId}/notes?${params.toString()}`, {
        headers: { Authorization: "Bearer " + token }
      });
      const data = await r.json().catch(() => ({}));
      if (!r.ok) {
        fileList.innerHTML = `<div class="file">Error loading notes</div>`;
        return;
      }
      const query = searchInput.value.trim().toLowerCase();
      notesCache = (data.notes || []).filter(n => {
        if (!query) return true;
        const blob = `${deriveTitle(n)}`.toLowerCase();
        return blob.includes(query);
      });
      renderFileList();
      renderTabs();
      if (activeNoteId == null && notesCache.length) {
        setActiveNote(notesCache[0].id, true);
      } else if (activeNoteId != null) {
        const detail = noteDetails.get(activeNoteId);
        if (detail) renderNote(detail);
      }
    }

    function renderFileList() {
      fileList.innerHTML = "";
      notesCache.forEach(n => {
        const el = document.createElement("div");
        el.className = "file";
        el.dataset.id = n.id;
        el.innerHTML = `
          <div>${escapeHtml(deriveTitle(n))}</div>
          <div class="small" style="color: var(--muted);">${new Date(n.updated_at || n.created_at).toLocaleString()}</div>
        `;
        el.onclick = () => setActiveNote(n.id, true);
        fileList.appendChild(el);
      });
      highlightActive();
    }

    async function setActiveNote(id, fetchDetail = false) {
      activeNoteId = id;
      highlightActive();
      if (!fetchDetail) {
        const cached = noteDetails.get(id);
        if (cached) {
          renderNote(cached);
          return;
        }
      }
      if (!currentVaultId) return;
      const r = await fetch(`/vaults/${currentVaultId}/notes/${id}`, {
        headers: { Authorization: "Bearer " + token }
      });
      const data = await r.json().catch(() => ({}));
      if (!r.ok) {
        return;
      }
      if (data.note) {
        noteDetails.set(id, data.note);
        renderNote(data.note);
      }
    }

    async function saveActiveNote() {
      if (!currentVaultId || !activeNoteId) return;
      noteStatus.textContent = "Saving...";
      const body = {
        title: noteTitleInput.value,
        content: noteContentInput.value,
        folder_id: currentFolderId
      };
      const r = await fetch(`/vaults/${currentVaultId}/notes/${activeNoteId}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token
        },
        body: JSON.stringify(body)
      });
      const data = await r.json().catch(() => ({}));
      if (!r.ok) {
        noteStatus.textContent = data.error || "Save failed";
        return;
      }
      noteStatus.textContent = "Saved";
      noteDetails.set(activeNoteId, data.note);
      await loadNotes();
    }

    function scheduleSave() {
      noteStatus.textContent = "Editing‚Ä¶";
      if (saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(() => {
        saveActiveNote();
      }, 800);
    }

    noteContentInput.addEventListener("input", () => {
      updateCounts(noteContentInput.value);
      scheduleSave();
    });

    noteTitleInput.addEventListener("input", scheduleSave);

    setSidebarMode("explorer");
    loadVaults();
  </script>
</body>
</html>
